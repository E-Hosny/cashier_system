# ุฅุตูุงุญ ูุดููุฉ ุชูุฑุงุฑ ุงูุนูุงุตุฑ ูู ูุฒุงููุฉ ุงูุทูุจุงุช ุงูุฃูููุงูู

## ุงููุดููุฉ ุงููุญุฏุฏุฉ

ูุงูุช ุนูููุฉ ูุฒุงููุฉ ุงูุทูุจุงุช ุงูุฃูููุงูู ุชุนุงูู ูู ูุดุงูู ุฎุทูุฑุฉ:

1. **ุชูุฑุงุฑ ุงูุนูุงุตุฑ**: ุนูุฏ ุฑุฌูุน ุงูุฅูุชุฑูุช ูุชุดุบูู ุงููุฒุงููุฉุ ูุชู ุชุณุฌูู ุนูุงุตุฑ ุฅุถุงููุฉ ุฃู ููุฑุฑุฉ
2. **ูุฒุงููุฉ ูุชุนุฏุฏุฉ**: ุชุดุบูู ุนูููุฉ ุงููุฒุงููุฉ ุนุฏุฉ ูุฑุงุช ููุทูุจ ุงููุงุญุฏ
3. **ุนุฏู ุงูุชุญูู ูู ุงูุญุงูุฉ**: ุนุฏู ุงูุชุฃูุฏ ูู ุญุงูุฉ ุงูุทูุจ ูุจู ุงููุฒุงููุฉ
4. **ููุฏุงู ุงูุจูุงูุงุช**: ูู ุญุงูุฉ ูุดู ุฌุฒุก ูู ุงูุนูููุฉ

## ุณุจุจ ุงููุดููุฉ

### ุงูููุฏ ุงููุฏูู (ุงููุดููุฉ):
```php
public static function syncOfflineOrders()
{
    $pendingOrders = OfflineOrder::getPendingSync($userId);
    
    foreach ($pendingOrders as $offlineOrder) {
        DB::transaction(function () use ($offlineOrder) {
            $order = $offlineOrder->convertToOrder();
            $offlineOrder->createOrderItems($order->id);        // โ ุจุฏูู ุชุญูู
            $offlineOrder->createStockMovements($order->id);    // โ ุจุฏูู ุชุญูู
            $offlineOrder->updateSyncStatus('synced');
        });
    }
}
```

### ุงููุดุงูู ูู ุงูููุฏ ุงููุฏูู:
1. **ุนุฏู ูุฌูุฏ ููู**: ูููู ุชุดุบูู ุงููุฒุงููุฉ ุนุฏุฉ ูุฑุงุช ูุชูุงุฒูุงู
2. **ุนุฏู ุงูุชุญูู ูู ุงููุฌูุฏ**: ูุง ูุชุญูู ูู ูุฌูุฏ ุทูุจ ูุฒุงูู ูุณุจูุงู
3. **ุนุฏู ุงูุชุญูู ูู ุงูุนูุงุตุฑ**: ูุถูู ุนูุงุตุฑ ุจุฏูู ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏูุง
4. **ุนุฏู ุฅุฏุงุฑุฉ ุงูุญุงูุงุช**: ูุง ูุชุนุงูู ูุน ุงูุญุงูุงุช ุงููุฎุชููุฉ ุจุดูู ุตุญูุญ

## ุงูุญู ุงููุทุจู

### 1. ุฅุถุงูุฉ ูุธุงู ููู ูููุฒุงููุฉ

```php
// ููู ุนูููุฉ ุงููุฒุงููุฉ ููุฏุฉ 5 ุฏูุงุฆู
$lockKey = "sync_offline_orders_{$userId}";
if (\Illuminate\Support\Facades\Cache::has($lockKey)) {
    return ['success' => false, 'message' => 'ุนูููุฉ ูุฒุงููุฉ ุฌุงุฑูุฉ ุจุงููุนู'];
}
\Illuminate\Support\Facades\Cache::put($lockKey, true, 300);
```

### 2. ุงูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ

```php
// ุงูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ ูุฑุฉ ุฃุฎุฑู (ุชุฌูุจ race conditions)
$offlineOrder->refresh();

if ($offlineOrder->status !== 'pending_sync') {
    $skippedCount++;
    continue;
}
```

### 3. ุงูุชุญูู ูู ุงูุทูุจุงุช ุงููุฒุงููุฉ ูุณุจูุงู

```php
// ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุทูุจ ูุฒุงูู ูุณุจูุงู
$existingOrder = Order::where('invoice_number', $offlineOrder->invoice_number)->first();
if ($existingOrder) {
    $offlineOrder->updateSyncStatus('synced');
    $skippedCount++;
    continue;
}
```

### 4. ุญุงูุฉ "syncing" ูููุน ุงููุฒุงููุฉ ุงููุชูุฑุฑุฉ

```php
// ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู "ููุฏ ุงููุฒุงููุฉ"
$offlineOrder->updateSyncStatus('syncing');
```

### 5. ุงูุชุญูู ูู ุงูุนูุงุตุฑ ูุงูุญุฑูุงุช

```php
// ุฅูุดุงุก ุนูุงุตุฑ ุงูุทูุจ ูุน ุงูุชุญูู ูู ุนุฏู ูุฌูุฏูุง ูุณุจูุงู
$existingItems = OrderItem::where('order_id', $order->id)->count();
if ($existingItems === 0) {
    $itemsCreated = $offlineOrder->createOrderItems($order->id);
} else {
    Log::warning("ุนูุงุตุฑ ุงูุทูุจ ููุฌูุฏุฉ ูุณุจูุงู ููุทูุจ {$order->id}");
}

// ุฅูุดุงุก ุญุฑูุงุช ุงููุฎุฒูู ูุน ุงูุชุญูู ูู ุนุฏู ูุฌูุฏูุง ูุณุจูุงู
$existingMovements = StockMovement::where('related_order_id', $order->id)->count();
if ($existingMovements === 0 && !empty($offlineOrder->stock_movements)) {
    $movementsCreated = $offlineOrder->createStockMovements($order->id);
    self::updateStockFromMovements($offlineOrder->stock_movements);
}
```

## ุงูุฃูุงูุฑ ุงูุฌุฏูุฏุฉ

### 1. ุชูุธูู ุงูุทูุจุงุช ุงูููุฑุฑุฉ
```bash
# ูุนุงููุฉ ุงููุดุงูู
php artisan offline:cleanup --dry-run

# ุฅุตูุงุญ ุงููุดุงูู
php artisan offline:cleanup --force
```

### 2. ุงุฎุชุจุงุฑ ุงููุธุงู ุงูุฃูููุงูู
```bash
# ุงุฎุชุจุงุฑ ุดุงูู ูููุธุงู ุงูุฃูููุงูู
php artisan invoices:test-offline --user-id=1
```

## ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### โ **ููุน ุงููุฒุงููุฉ ุงููุชูุฑุฑุฉ**
- ูุธุงู ููู ูููุน ุชุดุบูู ุนุฏุฉ ุนูููุงุช ูุฒุงููุฉ ูุชูุงุฒูุงู
- ุญุงูุฉ "syncing" ุชููุน ุฅุนุงุฏุฉ ูุนุงูุฌุฉ ููุณ ุงูุทูุจ

### โ **ุงูุชุญูู ุงูุดุงูู ูู ุงูุจูุงูุงุช**
- ูุญุต ูุฌูุฏ ุงูุทูุจ ุงููุฒุงูู ูุณุจูุงู
- ูุญุต ูุฌูุฏ ุงูุนูุงุตุฑ ูุจู ุงูุฅุถุงูุฉ
- ูุญุต ูุฌูุฏ ุญุฑูุงุช ุงููุฎุฒูู ูุจู ุงูุฅุถุงูุฉ

### โ **ุฅุฏุงุฑุฉ ูุญุณูุฉ ููุญุงูุงุช**
```php
// ุงูุญุงูุงุช ุงููุฏุนููุฉ:
- 'pending_sync'  // ูู ุงูุชุธุงุฑ ุงููุฒุงููุฉ
- 'syncing'       // ููุฏ ุงููุฒุงููุฉ (ุฌุฏูุฏุฉ)
- 'synced'        // ุชู ุงููุฒุงููุฉ
- 'failed'        // ูุดูุช ุงููุฒุงููุฉ
```

### โ **ุชุณุฌูู ุดุงูู ููุฃุฎุทุงุก**
```php
Log::error($error, [
    'offline_order_id' => $offlineOrder->id,
    'offline_id' => $offlineOrder->offline_id,
    'invoice_number' => $offlineOrder->invoice_number,
    'exception' => $e
]);
```

### โ **ุขููุฉ rollback ูุญุณูุฉ**
- ุงุณุชุฎุฏุงู database transactions
- ุฅุนุงุฏุฉ ุชุนููู ุงูุญุงูุฉ ูู ุญุงูุฉ ุงููุดู
- ุชูุธูู ุงูููู ูู ุฌููุน ุงูุญุงูุงุช

## ุงูุณููุงุฑูููุงุช ุงููุญูููุฉ

### ุงูุณููุงุฑูู 1: ูุฒุงููุฉ ูุชุนุฏุฏุฉ
**ูุจู**: ูููู ุชุดุบูู ุงููุฒุงููุฉ ุนุฏุฉ ูุฑุงุช โ ุนูุงุตุฑ ููุฑุฑุฉ
**ุจุนุฏ**: ูุธุงู ุงูููู ูููุน ุงููุฒุงููุฉ ุงููุชุนุฏุฏุฉ โ

### ุงูุณููุงุฑูู 2: ุงููุทุงุน ุฃุซูุงุก ุงููุฒุงููุฉ
**ูุจู**: ุทูุจ ูุนูู ูู ุญุงูุฉ ุบูุฑ ูุงุถุญุฉ
**ุจุนุฏ**: ุญุงูุฉ "syncing" + ุขููุฉ ุชูุธูู ููุทูุจุงุช ุงููุนููุฉ โ

### ุงูุณููุงุฑูู 3: ุทูุจ ูุฒุงูู ูุณุจูุงู
**ูุจู**: ุฅุนุงุฏุฉ ุฅูุดุงุก ุงูุทูุจ โ ุชูุฑุงุฑ
**ุจุนุฏ**: ูุญุต ูุฌูุฏ ุงูุทูุจ + ุชุญุฏูุซ ุงูุญุงูุฉ โ

### ุงูุณููุงุฑูู 4: ูุดู ุฌุฒุฆู
**ูุจู**: ุจูุงูุงุช ูุงูุตุฉ ุฃู ููุฑุฑุฉ
**ุจุนุฏ**: ูุญุต ุดุงูู + rollback ูุงูู โ

## ูุซุงู ุนูู ุงูุชุดุบูู

### ูุจู ุงูุฅุตูุงุญ โ:
```
๐ด ุงููุทุงุน ุงููุช - ุฅูุดุงุก ุทูุจ ุฃูููุงูู: 250806-001
๐ ุฑุฌูุน ุงููุช - ุชุดุบูู ุงููุฒุงููุฉ ุงูุฃููู
๐ ุชุดุบูู ุงููุฒุงููุฉ ุงูุซุงููุฉ (ุฎุทุฃ ูู ุงููุณุชุฎุฏู)
๐ ุงููุชูุฌุฉ: 
   - ุทูุจ ูุงุญุฏ ูู orders
   - ุนูุงุตุฑ ููุฑุฑุฉ ูู order_items
   - ุญุฑูุงุช ูุฎุฒูู ููุฑุฑุฉ
```

### ุจุนุฏ ุงูุฅุตูุงุญ โ:
```
๐ด ุงููุทุงุน ุงููุช - ุฅูุดุงุก ุทูุจ ุฃูููุงูู: 250806-001
๐ ุฑุฌูุน ุงููุช - ุชุดุบูู ุงููุฒุงููุฉ ุงูุฃููู โ
๐ ูุญุงููุฉ ุชุดุบูู ุงููุฒุงููุฉ ุงูุซุงููุฉ
   โ "ุนูููุฉ ูุฒุงููุฉ ุฌุงุฑูุฉ ุจุงููุนูุ ูุฑุฌู ุงูุงูุชุธุงุฑ"
๐ ุงููุชูุฌุฉ:
   - ุทูุจ ูุงุญุฏ ูู orders โ
   - ุนูุงุตุฑ ุตุญูุญุฉ ุจุฏูู ุชูุฑุงุฑ โ
   - ุญุฑูุงุช ูุฎุฒูู ุตุญูุญุฉ โ
```

## ุฃูุงูุฑ ุงูุตูุงูุฉ

### ูุญุต ุฏูุฑู ูููุดุงูู:
```bash
# ูุญุต ูููู ููุทูุจุงุช ุงูููุฑุฑุฉ
php artisan offline:cleanup --dry-run

# ุชูุธูู ุฃุณุจูุนู
php artisan offline:cleanup --force
```

### ูุฑุงูุจุฉ ุงูุญุงูุงุช:
```bash
# ูุญุต ุงูุทูุจุงุช ุงููุนููุฉ
php artisan tinker --execute="
use App\Models\OfflineOrder;
echo 'ูุนููุฉ: ' . OfflineOrder::where('status', 'pending_sync')->count();
echo 'ููุฏ ุงููุฒุงููุฉ: ' . OfflineOrder::where('status', 'syncing')->count();
echo 'ูุฒุงููุฉ: ' . OfflineOrder::where('status', 'synced')->count();
echo 'ูุงุดูุฉ: ' . OfflineOrder::where('status', 'failed')->count();
"
```

## ุงููููุงุช ุงููุญุฏุซุฉ

### ุงููููุงุช ุงููุญุณูุฉ:
- `app/Services/OfflineService.php` โ ุฅุตูุงุญ ุดุงูู ูุนูููุฉ ุงููุฒุงููุฉ
- `app/Models/OfflineOrder.php` โ ุฅุถุงูุฉ ุญุงูุฉ "syncing" ูุฏุนู ุงูุทูุจุงุช ุงููุงุดูุฉ

### ุงููููุงุช ุงูุฌุฏูุฏุฉ:
- `app/Console/Commands/CleanupOfflineOrders.php` โ ุฃูุฑ ุชูุธูู ุดุงูู
- `app/Console/Commands/TestOfflineInvoicing.php` โ ุงุฎุชุจุงุฑ ุดุงูู ูููุธุงู ุงูุฃูููุงูู

## ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู ุงููุฒุงููุฉ:

1. **โ ููุน ุชูุฑุงุฑ ุงูุนูุงุตุฑ**: ูุญุต ุดุงูู ูุจู ุงูุฅุถุงูุฉ
2. **โ ููุน ุงููุฒุงููุฉ ุงููุชุนุฏุฏุฉ**: ูุธุงู ููู ูุญูู
3. **โ ุฅุฏุงุฑุฉ ุงูุญุงูุงุช**: ุญุงูุงุช ูุงุถุญุฉ ูููุทููุฉ
4. **โ ุชุณุฌูู ุดุงูู**: ุชุชุจุน ูุงูู ููุฃุฎุทุงุก ูุงูุนูููุงุช
5. **โ ุฃุฏูุงุช ุตูุงูุฉ**: ุฃูุงูุฑ ุชูุธูู ููุญุต ุดุงููุฉ

**ุงููุชูุฌุฉ**: ูุธุงู ูุฒุงููุฉ ููู ูููุซูู ูุถูู ุนุฏู ุชูุฑุงุฑ ุงูุจูุงูุงุช ุฃู ููุฏุงููุง! ๐ 