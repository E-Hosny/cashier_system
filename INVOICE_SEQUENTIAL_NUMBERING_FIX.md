# ุฅุตูุงุญ ูุธุงู ุชุฑููู ุงูููุงุชูุฑ ุงููุชุณูุณู - ุงูุญู ุงูููุงุฆู

## ุงููุดููุฉ ุงูููุฌูุฏุฉ

ูุงู ูุธุงู ุชุฑููู ุงูููุงุชูุฑ ูุนุงูู ูู ูุดุงูู ุนุฏูุฏุฉ:

1. **ูุฌูุงุช ูู ุงูุชุณูุณู**: ุฃุฑูุงู ููููุฏุฉ ูู ุชุณูุณู ุงูููุงุชูุฑ (ูุซู: 001, 002, 005, 007 - ููุฏุงู 003, 004, 006)
2. **ุฃุฑูุงู ุบุฑูุจุฉ**: ุธููุฑ ุฃุฑูุงู ุทูููุฉ ูุน timestamp ูุซู `250731-1753983372-6906`
3. **ุนุฏู ุชุณูุณู ุตุญูุญ**: ุชุฎุทู ุฃุฑูุงู ุนุดูุงุฆูุฉ
4. **ูุดุงูู ูู ุงููุนุงููุงุช ุงููุชูุงุฒูุฉ**: race conditions ุฃุฏุช ุฅูู ุชุถุงุฑุจ ูู ุงูุฃุฑูุงู

### ุฃูุซูุฉ ูู ุงูุตูุฑุฉ ุงููุฑููุฉ:
- ูุงุชูุฑุฉ ุฑูู: 372-250806 (40.00 ุฌููู)
- ูุงุชูุฑุฉ ุฑูู: 375-250806 (20.00 ุฌููู)  
- ูุงุชูุฑุฉ ุฑูู: 377-250806 (10.00 ุฌููู)
- ูุงุชูุฑุฉ ุฑูู: 379-250806 (20.00 ุฌููู)

**ุงููุดููุฉ**: ุชุฎุทู ุฑูู 374, 376, 378

## ุงูุญู ุงููุทุจู

### 1. ุฅูุดุงุก ุฌุฏูู ูููุตู ูููุชุชุงููุงุช

**ุงูููู**: `database/migrations/2025_08_06_000000_create_invoice_sequences_table.php`

```php
Schema::create('invoice_sequences', function (Blueprint $table) {
    $table->id();
    $table->string('date_code', 6)->comment('ููุฏ ุงูุชุงุฑูุฎ ุจุตูุบุฉ YYMMDD');
    $table->integer('current_sequence')->default(0)->comment('ุขุฎุฑ ุฑูู ุชุณูุณูู ุชู ุงุณุชุฎุฏุงูู');
    $table->timestamps();
    
    $table->unique('date_code');
    $table->index(['date_code', 'current_sequence']);
});
```

### 2. ุฅูุดุงุก ููุฏูู InvoiceSequence

**ุงูููู**: `app/Models/InvoiceSequence.php`

ุงููููุฒุงุช:
- **Thread-Safe**: ุงุณุชุฎุฏุงู `lockForUpdate()` ูููุน race conditions
- **Atomic Operations**: ุฌููุน ุงูุนูููุงุช ุฏุงุฎู transactions
- **ุชุตูุฑ ูููู**: ูู ููู ูู ูุชุชุงููุฉ ูููุตูุฉ

### 3. ุชุญุฏูุซ ุฎุฏูุฉ ุชุฑููู ุงูููุงุชูุฑ

**ุงูููู**: `app/Services/InvoiceNumberService.php`

#### ุงูููุฏ ุงููุฏูู (ุงููุดููุฉ):
```php
public static function generateInvoiceNumber($tenantId = null): string
{
    $maxAttempts = 10;
    $attempt = 0;
    
    do {
        $attempt++;
        $todayOrdersCount = Order::whereDate('created_at', $today)->count();
        $todayOfflineOrdersCount = OfflineOrder::whereDate('created_at', $today)->count();
        $dailySequence = $todayOrdersCount + $todayOfflineOrdersCount + $attempt;
        // ... ุงููุฒูุฏ ูู ุงูุชุนููุฏ
    } while ($attempt < $maxAttempts);
}
```

#### ุงูููุฏ ุงูุฌุฏูุฏ (ุงูุญู):
```php
public static function generateInvoiceNumber($tenantId = null): string
{
    $today = Carbon::today();
    $dateCode = $today->format('ymd');
    
    // ุงูุญุตูู ุนูู ุงูุฑูู ุงูุชุณูุณูู ุงูุชุงูู ุจุงุณุชุฎุฏุงู ุงููุธุงู ุงูุขูู
    $nextSequence = InvoiceSequence::getNextSequence($dateCode);
    
    // ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ ุจุงูุชูุณูู: YYMMDD-XXX
    $invoiceNumber = $dateCode . '-' . str_pad($nextSequence, 3, '0', STR_PAD_LEFT);
    
    return $invoiceNumber;
}
```

## ุงูุฃูุงูุฑ ุงูุฅุฏุงุฑูุฉ ุงูุฌุฏูุฏุฉ

### 1. ุชููุฆุฉ ุฌุฏูู ุงููุชุชุงููุงุช
```bash
# ุชููุฆุฉ ุฃููู
php artisan invoices:init-sequences

# ุฅุนุงุฏุฉ ุชููุฆุฉ ูุงููุฉ
php artisan invoices:init-sequences --force
```

### 2. ุงุฎุชุจุงุฑ ุงูุชุณูุณู
```bash
# ุงุฎุชุจุงุฑ ุชุณูุณูู
php artisan invoices:test-sequence --count=10

# ุงุฎุชุจุงุฑ ูุชูุงุฒู
php artisan invoices:test-sequence --count=10 --parallel=true
```

### 3. ุฅุตูุงุญ ุงููุฌูุงุช ุงูููุฌูุฏุฉ
```bash
# ูุนุงููุฉ ุงูุฅุตูุงุญ
php artisan invoices:fix-gaps --date=2025-07-31 --dry-run

# ุชุทุจูู ุงูุฅุตูุงุญ
php artisan invoices:fix-gaps --date=2025-07-31 --force
```

## ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

### ูุจู ุงูุฅุตูุงุญ:
```
โก ุงุฎุชุจุงุฑ ุงูุชูููุฏ ุงููุชูุงุฒู:
  ุงูุฏูุนุฉ 1: 250806-001, 250806-001, 250806-001  โ ุฃุฑูุงู ููุฑุฑุฉ
  
โ ูุฌุฏุช ุฃุฑูุงู ููุฑุฑุฉ: 250806-001, 250806-001, 250806-001, 250806-001
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
โก ุงุฎุชุจุงุฑ ุงูุชูููุฏ ุงููุชูุงุฒู:
  ุงูุฏูุนุฉ 1: 250806-001, 250806-002, 250806-003  โ ุชุณูุณู ุตุญูุญ
  ุงูุฏูุนุฉ 2: 250806-004, 250806-005, 250806-006
  
โ ูุง ุชูุฌุฏ ุฃุฑูุงู ููุฑุฑุฉ
โ ุงูุชุณูุณู ุตุญูุญ ุจุฏูู ูุฌูุงุช
```

## ุงูููุงุฆุฏ ุงูุฑุฆูุณูุฉ

### โ ุชุณูุณู ูุถููู
- ูุง ุชูุฌุฏ ูุฌูุงุช ูู ุงูุฃุฑูุงู
- ุชุตูุฑ ูููู ุตุญูุญ
- ุชุฑููู ูุชุณูุณู ูู 001, 002, 003...

### โ ุฃูุงู ูู ุงููุนุงููุงุช ุงููุชูุงุฒูุฉ
- ุงุณุชุฎุฏุงู database locks
- atomic operations
- ููุน race conditions

### โ ุฃุฏุงุก ูุญุณู
- ููุงุฑุณ ูุญุณูุฉ
- ุงุณุชุนูุงูุงุช ุฃุณุฑุน
- ุชุฎุฒูู ูุคูุช ูููุชุชุงููุงุช

### โ ุณูููุฉ ุงูุตูุงูุฉ
- ุฃูุงูุฑ ุฅุฏุงุฑูุฉ ุดุงููุฉ
- ุชุดุฎูุต ุงููุดุงูู
- ุฅุตูุงุญ ุชููุงุฆู ูููุฌูุงุช

## ุชูุณูู ุฃุฑูุงู ุงูููุงุชูุฑ ุงูุฌุฏูุฏ

### ุงูููุท: `YYMMDD-XXX`

**ุฃูุซูุฉ:**
- `250806-001` โ 6 ุฃุบุณุทุณ 2025ุ ุงููุงุชูุฑุฉ ุงูุฃููู
- `250806-002` โ 6 ุฃุบุณุทุณ 2025ุ ุงููุงุชูุฑุฉ ุงูุซุงููุฉ
- `250806-003` โ 6 ุฃุบุณุทุณ 2025ุ ุงููุงุชูุฑุฉ ุงูุซุงูุซุฉ

**ูููุฒุงุช:**
- **YYMMDD**: ููุฏ ุงูุชุงุฑูุฎ (6 ุฃุฑูุงู)
- **XXX**: ุงูุฑูู ุงูุชุณูุณูู ุงููููู (3 ุฃุฑูุงู ูุน ุฃุตูุงุฑ ุจุงุฏุฆุฉ)
- **ูุงุจู ูููู**: ูููู ุงุณุชุฎุฑุงุฌ ุงูุชุงุฑูุฎ ูุงูุชุณูุณู ูู ุงูุฑูู

## ูููุงุช ุชู ุฅูุดุงุคูุง/ุชุญุฏูุซูุง

### ุงููููุงุช ุงูุฌุฏูุฏุฉ:
- `database/migrations/2025_08_06_000000_create_invoice_sequences_table.php`
- `app/Models/InvoiceSequence.php`
- `app/Console/Commands/TestInvoiceSequence.php`
- `app/Console/Commands/FixInvoiceGaps.php`
- `app/Console/Commands/InitInvoiceSequences.php`

### ุงููููุงุช ุงููุญุฏุซุฉ:
- `app/Services/InvoiceNumberService.php` โ ุชุจุณูุท ูุจูุฑ ูู ุงูููุฏ

## ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุดุบูู Migration
```bash
php artisan migrate
```

### 2. ุชููุฆุฉ ุฌุฏูู ุงููุชุชุงููุงุช
```bash
php artisan invoices:init-sequences --force
```

### 3. ุงุฎุชุจุงุฑ ุงููุธุงู
```bash
php artisan invoices:test-sequence --count=10
```

### 4. ุฅุตูุงุญ ุงููุฌูุงุช ุงูููุฌูุฏุฉ (ุงุฎุชูุงุฑู)
```bash
# ูุญุต ุงููุฌูุงุช ุฃููุงู
php artisan invoices:fix-gaps --dry-run

# ุชุทุจูู ุงูุฅุตูุงุญ ุฅุฐุง ูุฒู ุงูุฃูุฑ
php artisan invoices:fix-gaps --force
```

## ูุฑุงูุจุฉ ุงููุธุงู

### ูุญุต ุฏูุฑู ูููุฌูุงุช
```bash
# ูุญุต ูุฌูุงุช ุงูููู ุงูุญุงูู
php artisan invoices:test-sequence --count=0

# ูุญุต ูุฌูุงุช ุชุงุฑูุฎ ูุญุฏุฏ
php artisan invoices:fix-gaps --date=2025-08-06 --dry-run
```

### ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ
ูููู ุฅุถุงูุฉ scheduled job ูุชูุธูู ุณุฌูุงุช ุงููุชุชุงููุงุช ุงููุฏููุฉ:

```php
// ูู app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    $schedule->call(function () {
        InvoiceSequence::cleanupOldSequences();
    })->weekly();
}
```

## ุงูุญุงูุงุช ุงูุฎุงุตุฉ

### ุฅุฐุง ูุดู ุฅูุดุงุก ูุงุชูุฑุฉ
ุงููุธุงู ุงูุฌุฏูุฏ ูุถูู ุนุฏู "ุถูุงุน" ุงูุฃุฑูุงู ุญุชู ูู ูุดู ุฅูุดุงุก ุงูุทูุจุ ูุฃู ุงูุฑูู ููุฎุตุต ูุณุจูุงู ูู ุฌุฏูู ูููุตู.

### ุงูุชุนุงูู ูุน ุงูุทูุจุงุช ุงูุฃูููุงูู
ุงููุธุงู ูุฏุนู ููุงู ูู:
- ุงูุทูุจุงุช ุงูุนุงุฏูุฉ (`orders`)
- ุงูุทูุจุงุช ุงูุฃูููุงูู (`offline_orders`)

ููุถูู ุชุณูุณู ููุญุฏ ุจููููุง.

## ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ูุธุงู ุชุฑููู ุงูููุงุชูุฑ ุจุงููุงูู ููุถูู:

1. **โ ุนุฏู ูุฌูุฏ ูุฌูุงุช**: ุชุณูุณู ูุถููู ุจุฏูู ุฃุฑูุงู ููููุฏุฉ
2. **โ ุฃูุงู ุงููุนุงููุงุช**: ููุน race conditions ูุงูุชุถุงุฑุจ
3. **โ ุณูููุฉ ุงูุตูุงูุฉ**: ุฃูุงูุฑ ุฅุฏุงุฑูุฉ ุดุงููุฉ
4. **โ ุฃุฏุงุก ูุญุณู**: ุงุณุชุนูุงูุงุช ุฃุณุฑุน ูููุงุฑุณ ูุญุณูุฉ
5. **โ ุงูุชูุงูู ูุน ุงููุธุงู ุงูููุฌูุฏ**: ูุนูู ูุน ุงูุทูุจุงุช ุงูุนุงุฏูุฉ ูุงูุฃูููุงูู

ุงูุขู ุณูุญุตู ูู ุฒุจูู ุนูู ุฑูู ูุงุชูุฑุฉ ูุชุณูุณู ุตุญูุญ ุจุฏูู ูุฌูุงุช! ๐ 