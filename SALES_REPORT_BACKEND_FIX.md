# إصلاح مشكلة التاريخ في تقرير المبيعات - الخادم

## المشكلة
كان التاريخ الافتراضي في الخادم يستخدم دائماً اليوم الحالي بغض النظر عن الوقت، مما يسبب عدم تطابق مع المنطق المطلوب.

## الحل
تم تحديث الكنترولر ليطبق نفس منطق التاريخ المستخدم في الواجهة الأمامية.

## التحديثات المطبقة

### 1. تحديث الكنترولر
**ملف**: `app/Http/Controllers/Admin/SalesReportController.php`

#### قبل التحديث
```php
$dateFrom = $request->input('date_from', Carbon::today()->toDateString());
```

#### بعد التحديث
```php
// الحصول على فترة التواريخ من المستخدم أو تعيين التاريخ الصحيح بناءً على الوقت الحالي
$now = Carbon::now();
$currentHour = $now->hour;

// تحديد التاريخ الافتراضي بناءً على الوقت الحالي
if ($currentHour < 7) {
    // قبل الساعة 7 صباحاً - نعرض مبيعات اليوم السابق
    $defaultDate = $now->subDay()->toDateString();
    \Log::info("قبل الساعة 7 - التاريخ الافتراضي: {$defaultDate}, الوقت الحالي: {$now->toDateTimeString()}");
} else {
    // بعد الساعة 7 صباحاً - نعرض مبيعات اليوم الحالي
    $defaultDate = $now->toDateString();
    \Log::info("بعد الساعة 7 - التاريخ الافتراضي: {$defaultDate}, الوقت الحالي: {$now->toDateTimeString()}");
}

$dateFrom = $request->input('date_from', $defaultDate);
```

### 2. إضافة سجلات للتتبع
تم إضافة سجلات لتتبع كيفية عمل المنطق:

```php
\Log::info("التاريخ النهائي المستخدم: {$dateFrom}, date_from من الطلب: " . $request->input('date_from', 'غير محدد'));
```

### 3. تحديث الواجهة الأمامية
**ملف**: `resources/js/Pages/Admin/SalesReport.vue`

#### أ. إزالة التاريخ الافتراضي من data()
```javascript
data() {
  return {
    dateFrom: this.date_from || this.date || '', // سنقوم بتعيين التاريخ الصحيح في mounted
    dateTo: this.date_to || '',
    selectedCategoryId: this.category_id || '',
    selectedProductId: this.product_id || '',
  };
}
```

#### ب. إضافة console.log للتتبع
```javascript
getTodayDate() {
  const now = new Date();
  const currentHour = now.getHours();
  
  console.log('الوقت الحالي:', now.toLocaleString('ar-EG'));
  console.log('الساعة الحالية:', currentHour);
  
  if (currentHour < 7) {
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const result = yesterday.toISOString().slice(0, 10);
    console.log('قبل الساعة 7 - التاريخ المحدد:', result);
    return result;
  } else {
    const result = now.toISOString().slice(0, 10);
    console.log('بعد الساعة 7 - التاريخ المحدد:', result);
    return result;
  }
}
```

## كيفية الاختبار

### 1. اختبار قبل الساعة 7 صباحاً
1. تأكد من أن وقت الخادم قبل الساعة 7 صباحاً
2. افتح صفحة تقارير المبيعات
3. تحقق من السجلات في `storage/logs/laravel.log`
4. تأكد من ظهور التاريخ الصحيح في حقل التاريخ

### 2. اختبار بعد الساعة 7 صباحاً
1. تأكد من أن وقت الخادم بعد الساعة 7 صباحاً
2. افتح صفحة تقارير المبيعات
3. تحقق من السجلات في `storage/logs/laravel.log`
4. تأكد من ظهور التاريخ الصحيح في حقل التاريخ

### 3. فحص السجلات
```bash
tail -f storage/logs/laravel.log
```

ابحث عن الرسائل التالية:
- "قبل الساعة 7 - التاريخ الافتراضي"
- "بعد الساعة 7 - التاريخ الافتراضي"
- "التاريخ النهائي المستخدم"

## أمثلة على السجلات المتوقعة

### قبل الساعة 7 صباحاً
```
[2024-01-18 03:00:00] local.INFO: قبل الساعة 7 - التاريخ الافتراضي: 2024-01-17, الوقت الحالي: 2024-01-18 03:00:00
[2024-01-18 03:00:00] local.INFO: التاريخ النهائي المستخدم: 2024-01-17, date_from من الطلب: غير محدد
```

### بعد الساعة 7 صباحاً
```
[2024-01-18 10:00:00] local.INFO: بعد الساعة 7 - التاريخ الافتراضي: 2024-01-18, الوقت الحالي: 2024-01-18 10:00:00
[2024-01-18 10:00:00] local.INFO: التاريخ النهائي المستخدم: 2024-01-18, date_from من الطلب: غير محدد
```

## الفوائد

### 1. اتساق في النظام
- نفس منطق التاريخ في الخادم والواجهة الأمامية
- تجنب التناقضات في البيانات
- تقارير أكثر دقة

### 2. سهولة التتبع
- سجلات مفصلة لمعرفة كيفية عمل النظام
- إمكانية اكتشاف المشاكل بسرعة
- تحسين الأداء

### 3. تجربة مستخدم محسنة
- عرض التاريخ الصحيح تلقائياً
- تقليل الحاجة للتدخل اليدوي
- واجهة أكثر وضوحاً

## الملفات المحدثة

- `app/Http/Controllers/Admin/SalesReportController.php`
  - تحديث منطق التاريخ الافتراضي
  - إضافة سجلات للتتبع
  - تحسين التعليقات

- `resources/js/Pages/Admin/SalesReport.vue`
  - إزالة التاريخ الافتراضي من data()
  - إضافة console.log للتتبع
  - تحسين دالة mounted()

## ملاحظات مهمة

1. **وقت الخادم**: تأكد من أن وقت الخادم صحيح
2. **السجلات**: راجع السجلات للتأكد من عمل النظام
3. **التوافق**: يعمل مع جميع المتصفحات
4. **الأداء**: لا يؤثر على أداء النظام 