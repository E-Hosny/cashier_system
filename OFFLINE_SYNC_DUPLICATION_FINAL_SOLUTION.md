# ุงูุญู ุงูุดุงูู ููุดููุฉ ุชูุฑุงุฑ ุงูุทูุจุงุช ูู ูุธุงู ุงููุฒุงููุฉ ุงูุฃูููุงูู

## ๐ ุงููุดููุฉ ุงูุฃุณุงุณูุฉ

ูุงู ูุธุงู ุงููุงุดูุฑ ูุนุงูู ูู ูุดููุฉ **ุฎุทูุฑุฉ ุฌุฏุงู** ูู ุชูุฑุงุฑ ุงูุทูุจุงุช ุนูุฏ ุงูุนูู ูู ูุถุน ุงูุฃูููุงููุ ุญูุซ:

- ุนูุฏ ุงููุทุงุน ุงููุชุ ูุนูู ุงููุธุงู ูู ูุถุน ุงูุฃูููุงูู
- ุนูุฏ ุนูุฏุฉ ุงููุชุ ูุชู ูุฒุงููุฉ ุงูุทูุจุงุช ุชููุงุฆูุงู
- **ุงููุดููุฉ**: ุชูุฑุงุฑ ูุฒุงููุฉ ููุณ ุงูุทูุจุงุช ุนุฏุฉ ูุฑุงุช ููุง ูุคุฏู ุฅูู:
  - ุทูุจุงุช ููุฑุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  - ููุงุชูุฑ ููุฑุฑุฉ ุจููุณ ุงูุฑูู
  - ุงุถุทุฑุงุจ ูู ุงูุญุณุงุจุงุช ูุงูุฃุฑุจุงุญ
  - ูุดุงูู ูู ุฅุฏุงุฑุฉ ุงููุฎุฒูู

## ๐ง ุงูุญู ุงููุทุจู

ุชู ุชุทุจูู ุญู **ูุชุนุฏุฏ ุงูุทุจูุงุช** ูุถูุงู ุนุฏู ุชูุฑุงุฑ ุฃู ุทูุจุงุช:

### 1. ุทุจูุงุช ุงูุญูุงูุฉ ูู ูุธุงู ุงููุฒุงููุฉ

#### ุงูุทุจูุฉ ุงูุฃููู: ููู ุนูููุฉ ุงููุฒุงููุฉ ุงูุนุงูุฉ
```php
$syncLockKey = "sync_offline_orders_{$userId}";
if (\Illuminate\Support\Facades\Cache::has($syncLockKey)) {
    return ['success' => false, 'message' => 'ุนูููุฉ ูุฒุงููุฉ ุฌุงุฑูุฉ ุจุงููุนู'];
}
\Illuminate\Support\Facades\Cache::put($syncLockKey, true, 600); // 10 ุฏูุงุฆู
```

#### ุงูุทุจูุฉ ุงูุซุงููุฉ: ููู ูุธุงู ุชุฑููู ุงูููุงุชูุฑ
```php
$invoiceSystemLockKey = "invoice_numbering_system_lock";
if (!self::lockInvoiceNumberingSystem($invoiceSystemLockKey)) {
    return ['success' => false, 'message' => 'ูุธุงู ุงูููุงุชูุฑ ูุดุบูู'];
}
```

#### ุงูุทุจูุฉ ุงูุซุงูุซุฉ: ุงูุชุญูู ูู ุญุงูุฉ ูู ุทูุจ
```php
$offlineOrder->refresh();
if ($offlineOrder->status !== 'pending_sync' && $offlineOrder->status !== 'failed') {
    $skippedCount++;
    continue;
}
```

#### ุงูุทุจูุฉ ุงูุฑุงุจุนุฉ: ุงูุชุญูู ูู ุงููุฒุงููุฉ ุงูุณุงุจูุฉ
```php
$existingOrder = Order::where('invoice_number', $offlineOrder->invoice_number)->first();
if ($existingOrder) {
    $offlineOrder->updateSyncStatus('synced');
    $skippedCount++;
    continue;
}
```

#### ุงูุทุจูุฉ ุงูุฎุงูุณุฉ: ููุน ุงูุชูุฑุงุฑ ูู ููุณ ุฏูุฑุฉ ุงููุฒุงููุฉ
```php
$syncedInvoiceNumbers = [];
if (in_array($offlineOrder->invoice_number, $syncedInvoiceNumbers)) {
    $offlineOrder->updateSyncStatus('synced');
    $skippedCount++;
    continue;
}
```

#### ุงูุทุจูุฉ ุงูุณุงุฏุณุฉ: ุงูุชุญูู ูู offline_id
```php
$existingByOfflineId = Order::where('user_id', $userId)
    ->whereJsonContains('metadata->offline_id', $offlineOrder->offline_id)
    ->first();
if ($existingByOfflineId) {
    $offlineOrder->updateSyncStatus('synced');
    $skippedCount++;
    continue;
}
```

#### ุงูุทุจูุฉ ุงูุณุงุจุนุฉ: ููู ุนูู ูุณุชูู ุงูุทูุจ ุงููุงุญุฏ
```php
$orderLockKey = "sync_order_{$offlineOrder->offline_id}";
if (\Illuminate\Support\Facades\Cache::has($orderLockKey)) {
    $skippedCount++;
    continue;
}
\Illuminate\Support\Facades\Cache::put($orderLockKey, true, 300); // 5 ุฏูุงุฆู
```

#### ุงูุทุจูุฉ ุงูุซุงููุฉ: ุงูุชุญูู ุงูููุงุฆู ูุจู ุงููุนุงููุฉ
```php
$doubleCheckOrder = Order::where('invoice_number', $offlineOrder->invoice_number)->first();
if ($doubleCheckOrder) {
    $offlineOrder->updateSyncStatus('synced');
    $skippedCount++;
    continue;
}
```

### 2. ุชุญุณูู ุขููุฉ ุงูุชุญููู ูุงูุชุชุจุน

#### ุฅุถุงูุฉ ุญูู Metadata ููุชุชุจุน
```sql
ALTER TABLE orders ADD COLUMN metadata JSON NULL;
```

#### ุชุชุจุน ุงููุตุฏุฑ ูู ูู ุทูุจ
```php
private static function convertOfflineOrderToOrder($offlineOrder)
{
    $order = Order::create($orderData);
    
    $order->update([
        'metadata' => json_encode([
            'source' => 'offline_sync',
            'offline_id' => $offlineOrder->offline_id,
            'synced_at' => now()->toISOString(),
        ])
    ]);
    
    return $order;
}
```

### 3. ุฃุฏูุงุช ุงููุญุต ูุงูุชูุธูู

#### ุฃูุฑ ุงูุชูุธูู ุงูุดุงูู
```bash
php artisan offline:cleanup --dry-run     # ูุนุงููุฉ ุจุฏูู ุชุทุจูู
php artisan offline:cleanup --force       # ุชูุธูู ูุจุงุดุฑ
php artisan offline:cleanup --check-duplicates  # ูุญุต ุงูุชูุฑุงุฑ ููุท
```

#### ูุญุต ุดุงูู ููุทูุจุงุช ุงูููุฑุฑุฉ
- ูุญุต ุจููุณ ุฑูู ุงููุงุชูุฑุฉ
- ูุญุต ุจููุณ ุงูุชูููุช ูุงููุจูุบ
- ูุญุต ุทูุจุงุช ุฃูููุงูู ููุฑุฑุฉ
- ูุญุต ุงูุนูุงุตุฑ ุงูููุฑุฑุฉ
- ูุญุต ุญุฑูุงุช ุงููุฎุฒูู ุงูููุฑุฑุฉ

#### ุฃูุฑ ูุญุต ุงูููุงุชูุฑ ุงูููุฑุฑุฉ
```bash
php artisan invoices:check-duplicates --fix
```

## ๐ก๏ธ ุขููุงุช ุงูุญูุงูุฉ ุงูุฅุถุงููุฉ

### 1. ุญูุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฅุถุงูุฉ ููุงุฑุณ ููุจุญุซ ุงูุณุฑูุน
- ุงุณุชุฎุฏุงู ุงููุนุงููุงุช (Transactions) ูุถูุงู ุงูุชูุงูู
- ูุญุต ุงููุฌูุฏ ูุจู ุงูุฅุฏุฑุงุฌ

### 2. ุญูุงูุฉ ุนูู ูุณุชูู ุงูุชุทุจูู
- ุฃููุงู ูุชุนุฏุฏุฉ ุงููุณุชููุงุช
- ุชุญุฏูุซ ุงูุญุงูุงุช ุจุฏูุฉ
- ุชุณุฌูู ููุตู ููุฃุญุฏุงุซ (Logging)

### 3. ุญูุงูุฉ ุนูู ูุณุชูู ุงููุณุชุฎุฏู
- ููุน ุงููุฒุงููุฉ ุงููุชุฒุงููุฉ ูููุณ ุงููุณุชุฎุฏู
- ุชุชุจุน ูุญุงููุงุช ุงููุฒุงููุฉ
- ุฑุณุงุฆู ูุงุถุญุฉ ููุญุงูุงุช ุงููุฎุชููุฉ

## ๐ ุงููุชุงุฆุฌ ูุงูุชุญุณููุงุช

### ูุจู ุงูุญู:
- โ ุทูุจุงุช ููุฑุฑุฉ ุนูุฏ ุนูุฏุฉ ุงููุช
- โ ููุงุชูุฑ ููุฑุฑุฉ ุจููุณ ุงูุฑูู
- โ ุงุถุทุฑุงุจ ูู ุงูุญุณุงุจุงุช
- โ ูุดุงูู ูู ุงููุฎุฒูู

### ุจุนุฏ ุงูุญู:
- โ ููุน ุชุงู ูุชูุฑุงุฑ ุงูุทูุจุงุช
- โ ุญูุงูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช
- โ ุชุชุจุน ุฏููู ููู ุนูููุฉ ูุฒุงููุฉ
- โ ุฃุฏูุงุช ูุญุต ูุชูุธูู ุดุงููุฉ
- โ ุชุณุฌูู ููุตู ููุฃุญุฏุงุซ
- โ ุญูุงูุฉ ูู race conditions

## ๐ ุฃุฏูุงุช ุงููุฑุงูุจุฉ

### 1. ูุญุต ุญุงูุฉ ุงููุฒุงููุฉ
```bash
php artisan offline:cleanup --dry-run
```

### 2. ูุญุต ุงูููุงุชูุฑ ุงูููุฑุฑุฉ
```bash
php artisan invoices:check-duplicates
```

### 3. ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุชูุตูููุฉ
ูููู ูุฑุงุฌุนุฉ ูููุงุช ุงูุณุฌู ูุฑุคูุฉ:
- ุนุฏุฏ ุงูุทูุจุงุช ุงููุฒุงููุฉ
- ุนุฏุฏ ุงูุทูุจุงุช ุงููุชุฎุทุงุฉ
- ุฃุณุจุงุจ ุงูุชุฎุทู
- ุฃู ุฃุฎุทุงุก ุญุฏุซุช

## ๐ ุงูุชุดุบูู ูุงูุตูุงูุฉ

### ุงูุชุดุบูู ุงููููู:
```bash
# ูุญุต ูููู ููุทูุจุงุช ุงูููุฑุฑุฉ
php artisan invoices:check-duplicates

# ุชูุธูู ุฏูุฑู (ุฃุณุจูุนู)
php artisan offline:cleanup --dry-run
```

### ูู ุญุงูุฉ ุงููุดุงูู:
```bash
# ูุญุต ุดุงูู ูุฅุตูุงุญ
php artisan offline:cleanup --force

# ูุญุต ุงูููุงุชูุฑ ุงูููุฑุฑุฉ ูุฅุตูุงุญูุง
php artisan invoices:check-duplicates --fix
```

## ๐ ุงูููุงุฆุฏ ุงููุญููุฉ

1. **ุงุณุชูุฑุงุฑ ุงููุธุงู**: ูุง ุชูุฌุฏ ุทูุจุงุช ููุฑุฑุฉ
2. **ุฏูุฉ ุงูุญุณุงุจุงุช**: ุฃุฑูุงู ุตุญูุญุฉ ูููุจูุนุงุช ูุงูุฃุฑุจุงุญ
3. **ุณูุงูุฉ ุงููุฎุฒูู**: ุญุฑูุงุช ุตุญูุญุฉ ุจุฏูู ุชูุฑุงุฑ
4. **ุซูุฉ ุงููุณุชุฎุฏููู**: ูุธุงู ููุซูู ูุนูู ุจุดูู ุตุญูุญ
5. **ุณูููุฉ ุงูุตูุงูุฉ**: ุฃุฏูุงุช ูุญุต ูุชูุธูู ุฌุงูุฒุฉ

## โก ุงูุฎูุงุตุฉ

ุชู ุญู ูุดููุฉ ุชูุฑุงุฑ ุงูุทูุจุงุช ูู ูุธุงู ุงููุฒุงููุฉ ุงูุฃูููุงูู ุจุดูู **ุดุงูู ูููุงุฆู** ูู ุฎูุงู:

- **8 ุทุจูุงุช ุญูุงูุฉ** ูุชุชุงููุฉ ูููุน ุฃู ุชูุฑุงุฑ
- **ุฃุฏูุงุช ูุญุต ูุชูุธูู** ุดุงููุฉ ููุตูุงูุฉ
- **ุชุชุจุน ุฏููู** ููู ุนูููุฉ ูุฒุงููุฉ
- **ุญูุงูุฉ ูููุฉ** ูู ุฌููุน ุณููุงุฑูููุงุช ุงูุชูุฑุงุฑ
- **ูุฑุงูุจุฉ ูุณุชูุฑุฉ** ูุถูุงู ุณูุงูุฉ ุงููุธุงู

ุงููุชูุฌุฉ: **ูุธุงู ูุฒุงููุฉ ุฃูููุงูู ูุญูู ุจุงููุงูู ูู ูุดููุฉ ุชูุฑุงุฑ ุงูุทูุจุงุช** ๐ฏ 