# إصلاح صفحة المصروفات - تطبيق منطق الفترة الزمنية 7 صباحاً - 7 صباحاً

## المشكلة
كانت صفحة المصروفات تعرض مصروفات اليوم الحالي بغض النظر عن الوقت، بدلاً من اتباع منطق الفترة الزمنية الموحد (7 صباحاً - 7 صباحاً) المستخدم في باقي النظام.

## الحل
تم تحديث `ExpenseController` ليتابع نفس منطق الفترة الزمنية المستخدم في المبيعات والرواتب.

## التغييرات المطبقة

### 1. تحديث ExpenseController.php

#### قبل الإصلاح:
```php
// افتراضياً: عرض مصروفات اليوم الحالي
else {
    $query->whereDate('expense_date', Carbon::today());
}
```

#### بعد الإصلاح:
```php
// افتراضياً: عرض مصروفات الفترة الحالية (من 7 صباحاً إلى 7 صباحاً للوم التالي)
else {
    $now = Carbon::now();
    $currentHour = $now->hour;
    
    // تحديد التاريخ الصحيح بناءً على الوقت الحالي
    if ($currentHour < 7) {
        // قبل الساعة 7 صباحاً - نعرض مصروفات من 7 صباحاً اليوم السابق إلى 7 صباحاً اليوم الحالي
        $startDate = $now->copy()->subDay()->setTime(7, 0, 0);
        $endDate = $now->copy()->setTime(7, 0, 0);
        $defaultDate = $now->copy()->subDay()->toDateString();
    } else {
        // بعد الساعة 7 صباحاً - نعرض مصروفات من 7 صباحاً اليوم الحالي إلى 7 صباحاً للوم التالي
        $startDate = $now->copy()->setTime(7, 0, 0);
        $endDate = $now->copy()->addDay()->setTime(7, 0, 0);
        $defaultDate = $now->toDateString();
    }
    
    $query->whereBetween('created_at', [$startDate, $endDate]);
}
```

### 2. إضافة التاريخ الافتراضي للواجهة
```php
// تحديد التاريخ الافتراضي للعرض في الواجهة
$defaultExpenseDate = null;
if (!$request->filled('expense_date') && !$request->filled('from') && !$request->filled('to')) {
    $now = Carbon::now();
    $currentHour = $now->hour;
    if ($currentHour < 7) {
        $defaultExpenseDate = $now->copy()->subDay()->toDateString();
    } else {
        $defaultExpenseDate = $now->toDateString();
    }
}

return Inertia::render('Expenses/Index', [
    'expenses' => $expenses,
    'totalExpenses' => $totalExpenses,
    'filters' => [
        'expense_date' => $request->expense_date ?? $defaultExpenseDate,
        'from' => $request->from,
        'to' => $request->to,
    ],
]);
```

## النتائج

### قبل الإصلاح:
- **أي وقت**: يعرض مصروفات اليوم الحالي (من 00:00 إلى 23:59)

### بعد الإصلاح:
- **قبل الساعة 7 صباحاً**: يعرض مصروفات من 7 صباحاً اليوم السابق إلى 7 صباحاً اليوم الحالي
- **بعد الساعة 7 صباحاً**: يعرض مصروفات من 7 صباحاً اليوم الحالي إلى 7 صباحاً للوم التالي

## أمثلة عملية

### المثال الأول: دخول الساعة 1 صباحاً يوم 19 يوليو
- **الفترة المعروضة**: من 7 صباحاً يوم 18 يوليو إلى 7 صباحاً يوم 19 يوليو
- **التاريخ الافتراضي**: 18 يوليو
- **النتيجة**: يعرض المصروفات التي تم إنشاؤها في هذه الفترة

### المثال الثاني: دخول الساعة 8 صباحاً يوم 18 يوليو
- **الفترة المعروضة**: من 7 صباحاً يوم 18 يوليو إلى 7 صباحاً يوم 19 يوليو
- **التاريخ الافتراضي**: 18 يوليو
- **النتيجة**: يعرض المصروفات التي تم إنشاؤها في هذه الفترة

### المثال الثالث: دخول الساعة 1 صباحاً يوم 18 يوليو
- **الفترة المعروضة**: من 7 صباحاً يوم 17 يوليو إلى 7 صباحاً يوم 18 يوليو
- **التاريخ الافتراضي**: 17 يوليو
- **النتيجة**: يعرض المصروفات التي تم إنشاؤها في هذه الفترة

## الاختبار

### اختبار الساعة 1 صباحاً يوم 19 يوليو:
```bash
# الفترة: 2025-07-18 07:00:00 إلى 2025-07-19 07:00:00
# المصروفات الموجودة:
ID: 6, Description: الالال, Amount: 88.00, Created: 2025-07-18 04:25:48
ID: 7, Description: تتات, Amount: 77.00, Created: 2025-07-18 04:26:23
ID: 8, Description: تت, Amount: 99.00, Created: 2025-07-18 04:27:10
ID: 9, Description: تت, Amount: 66.00, Created: 2025-07-18 04:51:54
ID: 10, Description: اا, Amount: 878.00, Created: 2025-07-18 04:56:44
```

**النتيجة**: ✅ يعرض المصروفات الصحيحة للفترة المحددة

## الفوائد

1. **توحيد المنطق**: جميع الأنظمة (مبيعات، مصروفات، رواتب) تستخدم نفس الفترة الزمنية
2. **دقة التقارير**: المصروفات تُعرض للفترة الصحيحة حسب الوقت
3. **اتساق البيانات**: جميع الصفحات تعكس نفس الفترة الزمنية
4. **سهولة الفهم**: منطق موحد لجميع العمليات

## الملفات المحدثة

- `app/Http/Controllers/ExpenseController.php` - تحديث منطق الفلترة الافتراضي

## الخلاصة

تم إصلاح صفحة المصروفات بنجاح لتتبع منطق الفترة الزمنية الموحد (7 صباحاً - 7 صباحاً). الآن:

- ✅ قبل الساعة 7 صباحاً: يعرض مصروفات اليوم السابق
- ✅ بعد الساعة 7 صباحاً: يعرض مصروفات اليوم الحالي
- ✅ التاريخ الافتراضي يُعرض بشكل صحيح في الواجهة
- ✅ جميع الأنظمة تستخدم نفس المنطق الزمني 