# دليل اختبار نظام عدم الاتصال (Offline System)

## نظرة عامة
هذا الدليل يوضح كيفية اختبار نظام عدم الاتصال في نظام الكاشير للتأكد من أنه يعمل بشكل صحيح في جميع الحالات.

## المتطلبات الأساسية
- نظام كاشير يعمل على الخادم المحلي (`127.0.0.1:8000`)
- متصفح ويب حديث (Chrome, Firefox, Safari)
- أدوات المطور مفتوحة (F12)

## سيناريوهات الاختبار

### 1. اختبار حالة الاتصال العادية

#### الخطوات:
1. تأكد من أن الخادم يعمل
2. افتح المتصفح وانتقل إلى `http://127.0.0.1:8000/cashier`
3. سجل دخولك ككاشير
4. تحقق من مؤشر الاتصال في أعلى الصفحة (يجب أن يكون أخضر)

#### النتائج المتوقعة:
- مؤشر الاتصال يظهر "متصل" باللون الأخضر
- يمكن إضافة منتجات للسلة
- يمكن إصدار فواتير عادية

### 2. اختبار انقطاع الاتصال (Network Offline)

#### الخطوات:
1. افتح أدوات المطور (F12)
2. انتقل إلى علامة تبويب "Network"
3. اضغط على "Offline" checkbox
4. حاول إضافة منتج للسلة وإصدار فاتورة

#### النتائج المتوقعة:
- مؤشر الاتصال يتحول إلى "غير متصل" باللون الأحمر
- عند محاولة إصدار فاتورة، يتم إنشاء طلب أوفلاين محلي
- تظهر رسالة "تم حفظ الطلب في وضع عدم الاتصال"
- يتم طباعة فاتورة محلية
- يتم حفظ الطلب في localStorage

### 3. اختبار استعادة الاتصال

#### الخطوات:
1. في أدوات المطور، ألغِ تحديد "Offline"
2. انتظر بضع ثوانٍ
3. تحقق من مؤشر الاتصال

#### النتائج المتوقعة:
- مؤشر الاتصال يعود إلى "متصل" باللون الأخضر
- يتم مزامنة الطلبات المحلية تلقائياً
- تظهر رسالة "تم مزامنة X طلب تلقائياً بنجاح!"

### 4. اختبار الطلبات المحفوظة

#### الخطوات:
1. أنشئ عدة طلبات في وضع عدم الاتصال
2. انتقل إلى صفحة "الطلبات المحفوظة" (زر أرجواني)
3. تحقق من قائمة الطلبات المحفوظة

#### النتائج المتوقعة:
- تظهر جميع الطلبات المحفوظة في القائمة
- يمكن طباعة فواتير الطلبات المحفوظة
- يمكن حذف الطلبات المحفوظة

## فحص الأخطاء الشائعة

### خطأ NS_ERROR_OFFLINE
**السبب:** النظام يحاول إرسال طلب إلى الخادم حتى في وضع عدم الاتصال

**الحل:** تم إصلاح هذا في الإصدار الحالي باستخدام:
- فحص سريع للاتصال قبل إرسال الطلبات
- استخدام `fetch` بدلاً من `axios` للفحص
- إنشاء طلبات محلية مباشرة عند اكتشاف عدم الاتصال

### خطأ "Failed to create order: Order created successfully!"
**السبب:** استجابة الخادم لا تحتوي على حقل `success`

**الحل:** تم إصلاح هذا بإضافة حقل `success` في جميع الاستجابات

### خطأ JavaScript في المزامنة
**السبب:** محاولة مزامنة طلبات غير صحيحة

**الحل:** تم إضافة فحوصات للبيانات قبل المزامنة

## فحص localStorage

### الطلبات المحلية
```javascript
// فحص الطلبات المحلية
const localOrders = JSON.parse(localStorage.getItem('local_offline_orders') || '[]');
console.log('الطلبات المحلية:', localOrders);
```

### الطلبات المعلقة
```javascript
// فحص الطلبات المعلقة
const pendingRequests = JSON.parse(localStorage.getItem('offline_pending_requests') || '[]');
console.log('الطلبات المعلقة:', pendingRequests);
```

### آخر رقم فاتورة محلي
```javascript
// فحص آخر رقم فاتورة محلي
const lastInvoice = localStorage.getItem('last_local_invoice_number');
console.log('آخر رقم فاتورة محلي:', lastInvoice);
```

## اختبار الأداء

### وقت الاستجابة
- فحص الاتصال: أقل من 2 ثانية
- إنشاء طلب أوفلاين: أقل من 1 ثانية
- طباعة فاتورة محلية: أقل من 2 ثانية

### استهلاك الذاكرة
- مراقبة استخدام localStorage
- التأكد من عدم تراكم البيانات القديمة

## سجلات الأخطاء

### فحص سجلات المتصفح
```javascript
// فحص سجلات الأخطاء
console.log('حالة الاتصال:', window.offlineManager?.getConnectionStatus());
```

### فحص سجلات الخادم
```bash
# فحص سجلات Laravel
tail -f storage/logs/laravel.log
```

## استكشاف الأخطاء

### إذا لم يعمل النظام في وضع عدم الاتصال:
1. تحقق من أن JavaScript مفعل
2. تحقق من أن localStorage متاح
3. تحقق من سجلات المتصفح للأخطاء
4. تأكد من أن جميع الملفات محملة بشكل صحيح

### إذا لم تتم المزامنة:
1. تحقق من اتصال الإنترنت
2. تحقق من أن الخادم يعمل
3. تحقق من صلاحيات المستخدم
4. تحقق من سجلات الخادم

## ملاحظات مهمة

1. **البيانات المحلية:** جميع البيانات المحلية محفوظة في localStorage
2. **المزامنة التلقائية:** تحدث عند استعادة الاتصال
3. **الطباعة:** تعمل حتى في وضع عدم الاتصال
4. **الأمان:** البيانات محفوظة محلياً فقط ولا تنتقل عبر الشبكة في وضع عدم الاتصال

## الدعم

إذا واجهت أي مشاكل:
1. تحقق من هذا الدليل أولاً
2. راجع سجلات الأخطاء
3. تأكد من أن جميع الملفات محدثة
4. اتصل بالدعم الفني إذا استمرت المشكلة 