# ุงูุญู ุงูููุงุฆู ููุดููุฉ ุงูุชุถุงุฑุจ: ุงููุฒุงููุฉ ูุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ ุจุงูุชูุงุฒู

## ุงููุดููุฉ ุงูุญุฑุฌุฉ ุงูููุชุดูุฉ

ุชู ุงูุชุดุงู ุณููุงุฑูู ุฎุทูุฑ ุฌุฏุงู ูุญุฏุซ ุนูุฏูุง:
1. **๐ด ุฅุตุฏุงุฑ ููุงุชูุฑ ูู ูุถุน ุงูุฃูููุงูู**: ุทูุจุงุช ูุญููุธุฉ ุจุฑูู ูุงุชูุฑุฉ ูุซู `250806-003`
2. **๐ ุฑุฌูุน ุงูุฅูุชุฑูุช**: ุจุฏุก ุนูููุฉ ุงููุฒุงููุฉ 
3. **โก ุฅุตุฏุงุฑ ููุงุชูุฑ ุฌุฏูุฏุฉ ุจุงูุชูุงุฒู**: ุทูุจุงุช ุฌุฏูุฏุฉ ุฃุซูุงุก ุงููุฒุงููุฉ
4. **๐ฅ ุงููุชูุฌุฉ**: ุชุถุงุฑุจ ูู ุฃุฑูุงู ุงูููุงุชูุฑ ูุชุณุฌูู ุทูุจุงุช ุฅุถุงููุฉ

### ูุซุงู ุนูู ุงูุณููุงุฑูู ุงููุดูู:

```
๐ด ูุถุน ุฃูููุงูู:
   - ุทูุจ ุฃูููุงูู 1: 250806-001 (ูุญููุธ ุฃูุณ)
   - ุทูุจ ุฃูููุงูู 2: 250806-002 (ูุญููุธ ุฃูุณ)

๐ ุฑุฌูุน ุงููุช:
   [09:00] ุจุฏุก ุงููุฒุงููุฉ...
   [09:01] ๐ฑ ุฒุจูู ุฌุฏูุฏ ูุทูุจ โ ุงููุธุงู ูููุฏ: 250806-003
   [09:02] ๐ ุงููุฒุงููุฉ ุชุญุงูู ููู: 250806-001
   [09:03] ๐ฑ ุฒุจูู ุขุฎุฑ ูุทูุจ โ ุงููุธุงู ูููุฏ: 250806-004
   [09:04] ๐ ุงููุฒุงููุฉ ุชุญุงูู ููู: 250806-002
   
๐ฅ ุงููุชูุฌุฉ:
   - ุชุถุงุฑุจ ูู ุงูุฃุฑูุงู
   - ุทูุจุงุช ููุฑุฑุฉ
   - ูุฌูุงุช ูู ุงูุชุณูุณู
   - ุฎูู ูู ุงูุจูุงูุงุช
```

## ุงูุญู ุงููุทุจู: ูุธุงู ููู ูุชุนุฏุฏ ุงููุณุชููุงุช

### 1. ููู ูุธุงู ุชุฑููู ุงูููุงุชูุฑ ุฃุซูุงุก ุงููุฒุงููุฉ

```php
// ูู OfflineService::syncOfflineOrders()
$invoiceSystemLockKey = "invoice_numbering_system_lock";

// ููู ุงููุธุงู ููุฏุฉ 15 ุฏูููุฉ ุฃุซูุงุก ุงููุฒุงููุฉ
if (!self::lockInvoiceNumberingSystem($invoiceSystemLockKey)) {
    return ['success' => false, 'message' => 'ูุธุงู ุงูููุงุชูุฑ ูุดุบูู'];
}
```

### 2. ูุดู ูุญู ุงูุชุถุงุฑุจ ูู ุฃุฑูุงู ุงูููุงุชูุฑ

```php
// ูุญุต ูู ุทูุจ ุฃูููุงูู ูุจู ุงููุฒุงููุฉ
$needsRenumbering = self::checkInvoiceNumberConflict($currentInvoiceNumber);

if ($needsRenumbering) {
    // ุฅุนุงุฏุฉ ุชุฑููู ุงููุงุชูุฑุฉ ูุชุฌูุจ ุงูุชุถุงุฑุจ
    $newInvoiceNumber = InvoiceNumberService::generateInvoiceNumber();
    $offlineOrder->update(['invoice_number' => $newInvoiceNumber]);
    $renumberedCount++;
}
```

### 3. ุขููุฉ ุทูุงุฑุฆ ููุทูุจุงุช ุงูุฌุฏูุฏุฉ

```php
// ูู InvoiceNumberService::generateInvoiceNumber()
if (Cache::has('invoice_numbering_system_lock')) {
    // ุงูุชุธุงุฑ ูุตูุฑ ูููุฒุงููุฉ
    $attempts = 0;
    while (Cache::has($lockKey) && $attempts < 10) {
        sleep(1);
        $attempts++;
    }
    
    // ุฅุฐุง ุงุณุชูุฑ ุงููููุ ุงุณุชุฎุฏู ุฑูู ุทูุงุฑุฆ
    if (Cache::has($lockKey)) {
        return self::generateEmergencyInvoiceNumber();
    }
}
```

### 4. ูุธุงู ุฃุฑูุงู ุงูุทูุงุฑุฆ

```php
private static function generateEmergencyInvoiceNumber(): string
{
    $dateCode = Carbon::today()->format('ymd');
    $timestamp = time();
    $random = mt_rand(1000, 9999);
    
    // ุชูุณูู: 250806-EMG-1691234567-4321
    return $dateCode . '-EMG-' . $timestamp . '-' . $random;
}
```

## ููู ูุนูู ุงููุธุงู ุงูุฌุฏูุฏ

### ุงูุณููุงุฑูู ุงููุญููู:

```
๐ด ูุถุน ุฃูููุงูู:
   - ุทูุจ ุฃูููุงูู 1: 250806-001 (ูุญููุธ ุฃูุณ)
   - ุทูุจ ุฃูููุงูู 2: 250806-002 (ูุญููุธ ุฃูุณ)

๐ ุฑุฌูุน ุงููุช:
   [09:00] ๐ ุจุฏุก ุงููุฒุงููุฉ + ููู ูุธุงู ุงูููุงุชูุฑ
   [09:01] ๐ฑ ุฒุจูู ุฌุฏูุฏ ูุทูุจ โ ุงููุธุงู ููุชุธุฑ ุฃู ูููุฏ ุฑูู ุทูุงุฑุฆ
   [09:02] ๐ ูุญุต 250806-001 โ ูุง ููุฌุฏ ุชุถุงุฑุจ โ ูุฒุงููุฉ
   [09:03] ๐ฑ ุฒุจูู ุขุฎุฑ ููุชุธุฑ ุฃู ูุญุตู ุนูู ุฑูู ุทูุงุฑุฆ
   [09:04] ๐ ูุญุต 250806-002 โ ููุฌุฏ ุชุถุงุฑุจ โ ุฅุนุงุฏุฉ ุชุฑููู ูู 250806-003
   [09:05] ๐ ุงูุชูุงุก ุงููุฒุงููุฉ + ุฅูุบุงุก ุงูููู

โ ุงููุชูุฌุฉ:
   - ูุง ุชูุฌุฏ ุฃุฑูุงู ููุฑุฑุฉ
   - ุชุณูุณู ููุทูู
   - ุจูุงูุงุช ุณูููุฉ
   - ุงุณุชูุฑุงุฑูุฉ ุงูุฎุฏูุฉ
```

## ุงูููููุงุช ุงูุฌุฏูุฏุฉ

### 1. ูุธุงุฆู ุงูููู ูู OfflineService

```php
// ููู ุงููุธุงู
private static function lockInvoiceNumberingSystem($lockKey): bool

// ุฅูุบุงุก ุงูููู
private static function unlockInvoiceNumberingSystem($lockKey): void

// ูุญุต ุงูุชุถุงุฑุจ
private static function checkInvoiceNumberConflict($invoiceNumber): bool
```

### 2. ุชุญุณููุงุช InvoiceNumberService

```php
// ุงูุชุธุงุฑ ุฐูู ุฃุซูุงุก ุงูููู
if (Cache::has('invoice_numbering_system_lock')) {
    // ุงูุชุธุงุฑ + ุขููุฉ ุทูุงุฑุฆ
}

// ุชูููุฏ ุฃุฑูุงู ุทูุงุฑุฆ
private static function generateEmergencyInvoiceNumber(): string
```

### 3. ุฃูุฑ ุงุฎุชุจุงุฑ ุดุงูู

```bash
# ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ุงููุนูุฏ
php artisan test:concurrent-sync --user-id=1
```

## ุฃููุงุน ุฃุฑูุงู ุงูููุงุชูุฑ

### 1. ุงูุฃุฑูุงู ุงูุนุงุฏูุฉ
```
250806-001  โ ุงูููู ุงูุณุงุฏุณ ูู ุฃุบุณุทุณุ ุงููุงุชูุฑุฉ ุงูุฃููู
250806-002  โ ุงูููู ุงูุณุงุฏุณ ูู ุฃุบุณุทุณุ ุงููุงุชูุฑุฉ ุงูุซุงููุฉ
```

### 2. ุฃุฑูุงู ุงูุทูุงุฑุฆ
```
250806-EMG-1691234567-4321  โ ุฑูู ุทูุงุฑุฆ ูุน timestamp ูุนุดูุงุฆู
```

## ุงูุญุงูุงุช ูุงููุนุงูุฌุฉ

### ุงูุญุงูุฉ 1: ูุฒุงููุฉ ุนุงุฏูุฉ (ุจุฏูู ุทูุจุงุช ุฌุฏูุฏุฉ)
```
โ ุงููุฒุงููุฉ ุชุนูู ุจุดูู ุทุจูุนู
โ ูุง ููุฌุฏ ููู ุนูู ุงููุธุงู
โ ุฃุฑูุงู ูุชุณูุณูุฉ
```

### ุงูุญุงูุฉ 2: ุทูุจุงุช ุฌุฏูุฏุฉ (ุจุฏูู ูุฒุงููุฉ)
```
โ ุงูุทูุจุงุช ุชููุดุฃ ุจุดูู ุทุจูุนู
โ ุฃุฑูุงู ูุชุณูุณูุฉ
โ ูุง ุชูุฌุฏ ูุดุงูู
```

### ุงูุญุงูุฉ 3: ูุฒุงููุฉ + ุทูุจุงุช ุฌุฏูุฏุฉ (ุงูุญุงูุฉ ุงููุนูุฏุฉ)
```
๐ ุงููุธุงู ูููู ุชุฑููู ุงูููุงุชูุฑ
๐ ุงููุฒุงููุฉ ุชุนูู ุจุฃูุงู
โณ ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ ุชูุชุธุฑ ุฃู ุชุญุตู ุนูู ุฃุฑูุงู ุทูุงุฑุฆ
๐ ูุญุต ุงูุชุถุงุฑุจ ูุฅุนุงุฏุฉ ุงูุชุฑููู ุนูุฏ ุงูุญุงุฌุฉ
โ ุงูุชูุงุก ุขูู ููุนูููุงุช
```

## ุขููุฉ ูุดู ุงูุชุถุงุฑุจ

```php
private static function checkInvoiceNumberConflict($invoiceNumber): bool
{
    // ุงุณุชุฎุฑุงุฌ ุงูุฑูู ุงูุชุณูุณูู ูู ุงููุงุชูุฑุฉ ุงูุฃูููุงูู
    preg_match('/^(\d{6})-(\d{3})$/', $invoiceNumber, $matches);
    $sequenceNumber = (int)$matches[2];
    
    // ุงูุญุตูู ุนูู ุขุฎุฑ ุฑูู ุชุณูุณูู ุญุงูู
    $currentSequence = InvoiceSequence::where('date_code', $dateCode)
                                     ->value('current_sequence') ?? 0;
    
    // ุฅุฐุง ูุงู ุฑูู ุงูุทูุจ ุงูุฃูููุงูู โค ุงูุฑูู ุงูุญุงูู = ุชุถุงุฑุจ
    if ($sequenceNumber <= $currentSequence) {
        // ูุญุต ุฅุถุงูู: ูู ููุฌุฏ ุทูุจ ุจููุณ ุงูุฑููุ
        return Order::where('invoice_number', $invoiceNumber)->exists();
    }
    
    return false;
}
```

## ุงูุฃูุงูุฑ ุงููุชุงุญุฉ

### 1. ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ุงููุนูุฏ
```bash
# ุงุฎุชุจุงุฑ ูุงูู ูููุฒุงููุฉ + ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ
php artisan test:concurrent-sync --user-id=1
```

### 2. ุชูุธูู ุงููุดุงูู ุงูููุฌูุฏุฉ
```bash
# ูุญุต ูุฅุตูุงุญ ุงููุดุงูู
php artisan offline:cleanup --dry-run
php artisan offline:cleanup --force
```

### 3. ุงุฎุชุจุงุฑ ุงูุชุณูุณู ุงูุนุงุฏู
```bash
# ุงุฎุชุจุงุฑ ุชุฑููู ุงูููุงุชูุฑ ุงูุนุงุฏู
php artisan invoices:test-sequence --count=10
```

## ุงููุฑุงูุจุฉ ูุงูุตูุงูุฉ

### ูุญุต ุญุงูุฉ ุงููุธุงู
```bash
# ูุญุต ุงูุฃููุงู ุงููุดุทุฉ
php artisan tinker --execute="
use Illuminate\Support\Facades\Cache;
echo 'ููู ุงููุฒุงููุฉ: ' . (Cache::has('sync_offline_orders_1') ? 'ูุดุท' : 'ุบูุฑ ูุดุท');
echo 'ููู ูุธุงู ุงูููุงุชูุฑ: ' . (Cache::has('invoice_numbering_system_lock') ? 'ูุดุท' : 'ุบูุฑ ูุดุท');
"
```

### ูุญุต ุฃุฑูุงู ุงูุทูุงุฑุฆ
```bash
# ุงูุจุญุซ ุนู ุฃุฑูุงู ุงูุทูุงุฑุฆ
php artisan tinker --execute="
use App\Models\Order;
echo 'ุฃุฑูุงู ุงูุทูุงุฑุฆ: ' . Order::where('invoice_number', 'LIKE', '%-EMG-%')->count();
"
```

## ุงููุนุงูุฌุฉ ุงููุงุญูุฉ ูุฃุฑูุงู ุงูุทูุงุฑุฆ

ูููู ุฅูุดุงุก ุฃูุฑ ูุงุญูุงู ููุนุงูุฌุฉ ุฃุฑูุงู ุงูุทูุงุฑุฆ:

```bash
# ููุชุฑุญ ูุฃูุฑ ูุณุชูุจูู
php artisan invoices:process-emergency --date=2025-08-06
```

ูุฐุง ุงูุฃูุฑ ุณูููู ุจู:
1. ุงูุจุญุซ ุนู ุฃุฑูุงู ุงูุทูุงุฑุฆ
2. ุฅุนุงุฏุฉ ุชุฑููููุง ุจุฃุฑูุงู ูุชุณูุณูุฉ ุนุงุฏูุฉ
3. ุชุญุฏูุซ ุฌููุน ุงูุณุฌูุงุช ุงููุฑุชุจุทุฉ

## ุงูููุงุฆุฏ ุงููุญููุฉ

### โ **ููุน ุงูุชุถุงุฑุจ ุงูุชุงู**
- ูุง ูููู ุญุฏูุซ ุชุถุงุฑุจ ุจูู ุงููุฒุงููุฉ ูุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ
- ูุธุงู ููู ูุญูู ูุญูู ุณูุงูุฉ ุงูุจูุงูุงุช

### โ **ุงุณุชูุฑุงุฑูุฉ ุงูุฎุฏูุฉ**
- ุฃุฑูุงู ุงูุทูุงุฑุฆ ุชุถูู ุนุฏู ุชููู ุงููุธุงู
- ุงูุฒุจุงุฆู ูุญุตููู ุนูู ููุงุชูุฑ ุฏุงุฆูุงู

### โ **ุฅุนุงุฏุฉ ุชุฑููู ุฐููุฉ**
- ูุดู ุงูุชุถุงุฑุจ ุชููุงุฆูุงู
- ุฅุนุงุฏุฉ ุชุฑููู ุงูููุงุชูุฑ ุงููุฏููุฉ ุนูุฏ ุงูุญุงุฌุฉ

### โ **ูุฑุงูุจุฉ ุดุงููุฉ**
- ุชุณุฌูู ูุงูู ููุนูููุงุช
- ุฅุญุตุงุฆูุงุช ููุตูุฉ ูููุฒุงููุฉ

## ุงูุฎูุงุตุฉ

ุชู ุญู ุงููุดููุฉ ุงูุญุฑุฌุฉ ุจุงููุงูู ูู ุฎูุงู:

1. **๐ ูุธุงู ููู ูุชุนุฏุฏ ุงููุณุชููุงุช**: ูููุน ุงูุชุถุงุฑุจ ููุงุฆูุงู
2. **๐ ูุดู ุงูุชุถุงุฑุจ ุงูุฐูู**: ูุญุต ูุฅุตูุงุญ ุชููุงุฆู
3. **๐จ ุขููุฉ ุงูุทูุงุฑุฆ**: ุงุณุชูุฑุงุฑูุฉ ุงูุฎุฏูุฉ ุฏุงุฆูุงู
4. **๐ ูุฑุงูุจุฉ ุดุงููุฉ**: ุชุชุจุน ูุงูู ููุนูููุงุช
5. **๐งช ุงุฎุชุจุงุฑ ุดุงูู**: ุงูุชุฃูุฏ ูู ุนูู ุงููุธุงู

**ุงููุชูุฌุฉ**: ูุธุงู ูุฒุงููุฉ ููู ูููุซูู ูุชุนุงูู ูุน ุฃุนูุฏ ุงูุณููุงุฑูููุงุช ุจุฏูู ุฃู ุชุถุงุฑุจ ุฃู ููุฏุงู ููุจูุงูุงุช! ๐ 