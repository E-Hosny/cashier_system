# دليل إعداد وتشغيل نظام العمل في وضع عدم الاتصال

## المتطلبات الأساسية

- Laravel 11.x
- PHP 8.1+
- MySQL 8.0+
- Node.js 18+

## خطوات الإعداد

### 1. تشغيل الهجرات
```bash
php artisan migrate
```

### 2. تشغيل الأوامر المطلوبة
```bash
# تسجيل الأمر الجديد
php artisan make:command SyncOfflineOrders

# اختبار الأمر
php artisan offline:sync
```

### 3. إعداد الجدولة (اختياري)
```bash
# إضافة إلى crontab
* * * * * cd /path/to/your/project && php artisan schedule:run >> /dev/null 2>&1
```

### 4. بناء الأصول
```bash
npm install
npm run build
```

## كيفية الاستخدام

### للكاشير

1. **عند انقطاع الإنترنت:**
   - سيظهر مؤشر "غير متصل" في أعلى الشاشة
   - يمكن الاستمرار في إصدار الفواتير بشكل طبيعي
   - سيتم حفظ الطلبات محلياً

2. **عند عودة الاتصال:**
   - سيتم المزامنة تلقائياً
   - سيظهر مؤشر "متصل" في أعلى الشاشة
   - يمكن مراجعة الطلبات المحفوظة

### للمدير

1. **مراجعة الطلبات المحفوظة:**
   - الوصول إلى "الطلبات المحفوظة" من القائمة
   - عرض جميع الطلبات في وضع عدم الاتصال
   - مراجعة حالة كل طلب

2. **المزامنة اليدوية:**
   - الضغط على "مزامنة الطلبات"
   - إعادة محاولة الطلبات الفاشلة
   - تنظيف الطلبات المزامنة

## الأوامر المتاحة

### مزامنة الطلبات
```bash
# مزامنة جميع الطلبات المعلقة
php artisan offline:sync

# مزامنة طلبات مستخدم محدد
php artisan offline:sync --user-id=1

# إعادة محاولة الطلبات الفاشلة
php artisan offline:sync --retry-failed
```

### إحصائيات النظام
```bash
# عرض إحصائيات الطلبات
php artisan offline:sync --stats
```

## استكشاف الأخطاء

### مشاكل شائعة

1. **عدم مزامنة الطلبات:**
   ```bash
   # التحقق من حالة الاتصال
   php artisan offline:sync
   
   # مراجعة السجلات
   tail -f storage/logs/laravel.log
   ```

2. **فشل في إنشاء الطلب:**
   ```bash
   # التحقق من قاعدة البيانات
   php artisan migrate:status
   
   # إعادة تشغيل الخدمة
   php artisan config:clear
   php artisan cache:clear
   ```

3. **مشاكل في الطباعة:**
   - التحقق من إعدادات المتصفح
   - استخدام متصفح مختلف
   - طباعة يدوية من البيانات المحلية

## الملفات المهمة

### النماذج
- `app/Models/OfflineOrder.php` - نموذج الطلبات في وضع عدم الاتصال
- `app/Models/OfflineCache.php` - نموذج التخزين المؤقت

### الخدمات
- `app/Services/OfflineService.php` - خدمة إدارة العمليات

### المتحكمات
- `app/Http/Controllers/OfflineController.php` - متحكم إدارة الطلبات
- `app/Http/Controllers/CashierController.php` - متحكم الكاشير (محدث)

### الواجهات
- `resources/js/Pages/Offline/Index.vue` - واجهة إدارة الطلبات
- `resources/js/Pages/Cashier.vue` - واجهة الكاشير (محدثة)
- `resources/js/offline-manager.js` - مدير حالة الاتصال

### الهجرات
- `database/migrations/2025_01_20_000000_create_offline_orders_table.php`
- `database/migrations/2025_01_20_000001_create_offline_cache_table.php`

## الأمان

### حماية البيانات
- تشفير البيانات المخزنة محلياً
- نسخ احتياطية دورية
- تتبع جميع العمليات

### الصلاحيات
- التحقق من صلاحيات المستخدم
- حماية من الوصول غير المصرح
- تسجيل جميع العمليات

## الأداء

### تحسينات مقترحة
1. **تخزين مؤقت ذكي:**
   - تخزين البيانات الأكثر استخداماً
   - تنظيف البيانات القديمة تلقائياً

2. **مزامنة تدريجية:**
   - مزامنة الطلبات على دفعات
   - تجنب التحميل الزائد على الخادم

3. **ضغط البيانات:**
   - ضغط البيانات المخزنة محلياً
   - تقليل حجم التخزين المطلوب

## الدعم

### للمساعدة
- مراجعة سجلات الأخطاء في `storage/logs/`
- استخدام أمر `php artisan offline:sync` للتحقق
- مراجعة صفحة الإحصائيات في واجهة الإدارة

### التطوير المستقبلي
1. **مزامنة في الوقت الفعلي** باستخدام WebSockets
2. **تطبيق موبايل** للعمل في وضع عدم الاتصال
3. **نسخ احتياطية محلية** باستخدام SQLite
4. **تشفير متقدم** للبيانات المحلية
5. **تقارير متقدمة** للتحليل

---

**ملاحظة مهمة:** تأكد من اختبار النظام في بيئة مشابهة للإنتاج قبل النشر النهائي. 